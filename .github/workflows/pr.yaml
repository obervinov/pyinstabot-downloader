---
name: PR

on:
  push:
    branches:
      - '*'
      - '*/*'
      - '**'
      - '!main'

jobs:
  changelog:
    uses: obervinov/_templates/.github/workflows/changelog.yaml@v1.0.13

  pylint:
    uses: obervinov/_templates/.github/workflows/pylint.yaml@v1.0.13

  pytest:
    uses: obervinov/_templates/.github/workflows/pytest-with-vault.yaml@v1.0.13

  pyproject:
    uses: obervinov/_templates/.github/workflows/pyproject.yaml@v1.0.13

  build-pr-image:
    uses: obervinov/_templates/.github/workflows/docker.yaml@v1.0.13
    needs: [changelog, pylint, pytest, pyproject]

  delete-untagged-images:
    name: Delete all untagged images from this repository on GitHub Container Registry
    uses: Chizkiyahu/delete-untagged-ghcr-action@v3
    with:
      token: ${{ secrets.PACKAGE_REGISTRY_TOKEN }}
      repository_owner: ${{ github.repository_owner }}
      repository: ${{ github.repository }}
      untagged_only: true
      owner_type: user